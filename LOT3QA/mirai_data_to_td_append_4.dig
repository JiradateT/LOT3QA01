timezone: Asia/Bangkok

#schedule:
#  daily>: 16:25:00

_export:
  mail:
    from: TD_InterfaceQA@no-reply
    host: 172.30.2.203
    port: 25
    to: [jiradate_t@tripetch-it.co.th]

  plugin:
    repositories:
      - https://jitpack.io
    dependencies:
      - com.github.tamanyan:digdag-hangouts-chat:0.1.5
  webhook_url: https://chat.googleapis.com/v1/spaces/AAAAthNXAYA/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=Sp7mNeKkjzwQnmxR7TZE0c73TEk1x-7iUqygWb1NCQQ%3D
  workflow_name: Mirai data to TD Daily
  ENV: develop
  td:
    database: mirai_data_to_td
  
+start_message:
  sh>: echo start Mirai data to TD

+current_loc:
  sh>: pwd

+start_email:
  mail>: ./TD_Mirai_data_to_TD_mail_body_append.txt
  subject: Mirai data to TD Workflow 4 Daily Started 

+mirai_data_to_td_append:

  #workflow_4
  #AllData use in append + onetime
  ##Fix tabtab in select
  +36_m_dealer_network_r:
    sh>: export PATH=$PATH:/home/qemtdadmin/.bin/  ;    
         embulk run ~/DIGDAG_TD/TD_Embulk/mirai_to_td_replace/m_dealer_network_r.yml
    _error:
      mail>: ./mail_body_error.txt
      subject: Dealer Network Onetime Workflow Error

  #AllData use in append + onetime
  +37_m_hr_employee_master:
    sh>: export PATH=$PATH:/home/qemtdadmin/.bin/  ;    
         embulk run ~/DIGDAG_TD/TD_Embulk/mirai_to_td_replace/m_hr_employee_master.yml
    _error:
      mail>: ./mail_body_error.txt
      subject: Employee Master Workflow Error

  #AllData use in append + onetime
  ##Fix tabtab in select
  +38_m_model_information_r:
    sh>: export PATH=$PATH:/home/qemtdadmin/.bin/  ;    
         embulk run ~/DIGDAG_TD/TD_Embulk/mirai_to_td_replace/m_model_information_r.yml
    _error:
      mail>: ./mail_body_error.txt
      subject: Model Information Onetime Workflow Error

  #AllData use in append + onetime
  +39_m_quick_master_values:
    sh>: export PATH=$PATH:/home/qemtdadmin/.bin/  ;    
         embulk run ~/DIGDAG_TD/TD_Embulk/mirai_to_td_replace/m_quick_master_values.yml
    _error:
      mail>: ./mail_body_error.txt
      subject: Quick Master Values Workflow Error

  +40_m_repair_history_details:
    sh>: export PATH=$PATH:/home/qemtdadmin/.bin/  ;    
         embulk run ~/DIGDAG_TD/TD_Embulk/mirai_to_td_replace/m_repair_history_details.yml
    _error:
      mail>: ./mail_body_error.txt
      subject: Repair History Details Workflow Error

  +42_m_repair_history_header:
    sh>: export PATH=$PATH:/home/qemtdadmin/.bin/  ;    
         embulk run ~/DIGDAG_TD/TD_Embulk/mirai_to_td_replace/m_repair_history_header.yml
    _error:
      mail>: ./mail_body_error.txt
      subject: Repair History Header Workflow Error

  # Modify selet VS to TD
  +44_m_retail_sales_info:
    sh>: export PATH=$PATH:/home/qemtdadmin/.bin/  ;    
         embulk run ~/DIGDAG_TD/TD_Embulk/mirai_to_td_replace/m_retail_sales_info.yml
    _error:
      mail>: ./mail_body_error.txt
      subject: Retail Sales Info Workflow Error

  # Modify tabatab in selet
  +46_m_vehicle_dealer_group_parameters:
    sh>: export PATH=$PATH:/home/qemtdadmin/.bin/  ;    
         embulk run ~/DIGDAG_TD/TD_Embulk/mirai_to_td_replace/m_vehicle_dealer_group_parameters.yml
    _error:
      mail>: ./mail_body_error.txt
      subject: Vehicle Dealer Group parameter Workflow Error

  +48_m_vehicle_master:
    sh>: export PATH=$PATH:/home/qemtdadmin/.bin/  ;    
         embulk run ~/DIGDAG_TD/TD_Embulk/mirai_to_td_replace/m_vehicle_master.yml
    _error:
      mail>: ./mail_body_error.txt
      subject: Vehicle Master Workflow Error

  +update_master_tables:
    _parallel: true

    #workflow_4
    +16_upd_m_repair_history_details:
      _retry: 2

      +delete_diff_m_repair_history_details_data:
        sh>:
             cd ~/DIGDAG_TD/workflows/queries_mirai_diff ;
             td query -d mirai_test_qa -T presto -q m_repair_history_details_deletion_diff.sql

      +insert_diff_m_repair_history_details_data:
        sh>:
             cd ~/DIGDAG_TD/workflows/queries_mirai_diff ;
             td query -d mirai_test_qa -T presto -q m_repair_history_details_insertion_diff.sql

    +17_upd_m_repair_history_header:
      _retry: 2

      +delete_diff_m_repair_history_header_data:
        sh>:
             cd ~/DIGDAG_TD/workflows/queries_mirai_diff ;
             td query -d mirai_test_qa -T presto -q m_repair_history_header_deletion_diff.sql

      +insert_diff_m_repair_history_header_data:
        sh>:
             cd ~/DIGDAG_TD/workflows/queries_mirai_diff ;
             td query -d mirai_test_qa -T presto -q m_repair_history_header_insertion_diff.sql

    +18_upd_m_retail_sales_info:
      _retry: 2

      +delete_diff_m_retail_sales_info_data:
        sh>:
             cd ~/DIGDAG_TD/workflows/queries_mirai_diff ;
             td query -d mirai_test_qa -T presto -q m_retail_sales_info_deletion_diff.sql

      +insert_diff_m_retail_sales_info_data:
        sh>:
             cd ~/DIGDAG_TD/workflows/queries_mirai_diff ;
             td query -d mirai_test_qa -T presto -q m_retail_sales_info_insertion_diff.sql

    +19_upd_m_vehicle_dealer_group_parameters:
      _retry: 2

      +delete_diff_m_vehicle_dealer_group_parameters_data:
        sh>:
             cd ~/DIGDAG_TD/workflows/queries_mirai_diff ;
             td query -d mirai_test_qa -T presto -q m_vehicle_dealer_group_parameters_deletion_diff.sql

      +insert_diff_m_vehicle_dealer_group_parameters_data:
        sh>:
             cd ~/DIGDAG_TD/workflows/queries_mirai_diff ;
             td query -d mirai_test_qa -T presto -q m_vehicle_dealer_group_parameters_insertion_diff.sql

    +20_upd_m_vehicle_master:
      _retry: 2

      +delete_diff_m_vehicle_master_data:
        sh>:
             cd ~/DIGDAG_TD/workflows/queries_mirai_diff ;
             td query -d mirai_test_qa -T presto -q m_vehicle_master_deletion_diff.sql

      +insert_diff_m_vehicle_master_data:
        sh>:
             cd ~/DIGDAG_TD/workflows/queries_mirai_diff ;
             td query -d mirai_test_qa -T presto -q m_vehicle_master_insertion_diff.sql

+success_message:
    mail>: ./TD_Mirai_data_to_TD_mail_body_append.txt
    subject: Mirai data to TD Workflow 4 Daily Success 
